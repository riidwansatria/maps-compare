<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GeoJSON Editor with Leaflet</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
  />

  <style>
    #map {
      height: 80vh;
      width: 100%;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
    }
  </style>
</head>
<body>
  <h2>GeoJSON Editor</h2>
  <input type="file" id="geojson-upload" accept=".geojson,.json" />
  <button id="download-btn">Download Edited GeoJSON</button>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    const map = L.map('map').setView([35.7, 139.7], 10);

    // Add OSM base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // FeatureGroup to store editable layers
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Leaflet.draw control
    const drawControl = new L.Control.Draw({
      edit: {
        featureGroup: drawnItems,
        remove: true
      },
      draw: {
        polygon: true,
        polyline: true,
        rectangle: true,
        circle: false,
        marker: true,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    // On create
    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.addLayer(e.layer);
    });

    // Handle file upload
    document.getElementById('geojson-upload').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const geojson = JSON.parse(e.target.result);
          // Clear old layers
          drawnItems.clearLayers();
          // Add GeoJSON to map
          L.geoJSON(geojson, {
            onEachFeature: function (feature, layer) {
              drawnItems.addLayer(layer);
            }
          });
          map.fitBounds(drawnItems.getBounds());
        } catch (err) {
          alert('Invalid GeoJSON file.');
        }
      };
      reader.readAsText(file);
    });

    // Download edited GeoJSON
    document.getElementById('download-btn').addEventListener('click', () => {
      const data = drawnItems.toGeoJSON();
      const convertedData = JSON.stringify(data, null, 2);
      const blob = new Blob([convertedData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'edited.geojson';
      a.click();

      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
